import Head from 'next/head';
import dynamic from 'next/dynamic';
import { FcShop, FcNews } from 'react-icons/fc';
import {BsPinMapFill} from 'react-icons/bs'
import { useState, useEffect } from 'react';
import { pages } from "@/utils/contanst";
import { NextResponse } from "next/server";
import _ from 'lodash';
import { Modal, ModalHeader, ModalBody, ModalFooter } from 'reactstrap';
import axios from 'axios';

import Axios from "@/helper/axios.helper";
import Layout from '@/components/layout';
import CreatePost from "@/components/createPost"
import PostDashboard from "@/components/postDashboard";

export async function getServerSideProps({ req, res }) {
    const token = req.cookies["vechaitoken"];
    const { data } = await Axios({
        url: "/api/customer/getbytoken",
        method: "GET",
        headers: { authorization: token },
    });
    if (!data) NextResponse.redirect(new URL("/login", req.url));

    return {
        props: {
            userData: data[0] || {},
        },
    };
}


export default function Dashboard({ userData }) {
    const { fullname, name, email, accessApp } = userData; // accessApp = "dashboard, post"

    const [layoutPages, setLayoutPages] = useState([]);

    useEffect(() => {
        detectAccessPage()
    }, []);

    const renderContent = (roleName) => {
        if (roleName === "saler") {
            return <SalerComponent userData={userData}></SalerComponent>;
        } else if (roleName === "buyer") {
            return <BuyerComponent></BuyerComponent>;
        } else if (roleName === "yard") {
            return <YardComponent></YardComponent>;
        } else {
            return <h1></h1>
        }
    };

    const detectAccessPage = () => {
        const accessAppsList = accessApp.split(", ");
        if (accessAppsList && Array.isArray(accessAppsList)) {
            const userPages = _.filter(pages, (page) => {
                return accessAppsList.includes(page.key);
            });
            setLayoutPages(userPages);
        }
    }


    return (
        <>
            <Head>
                <title>Trang ch·ªß</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="ico" href="/favicon.ico"></link>
            </Head>
            <main>
                <Layout pages={layoutPages} user={{ fullname, name, email }}>
                    {renderContent(name, userData)}
                </Layout>
            </main>
        </>
    );
}

function BuyerComponent({ user = {} }) {
    const [posts, setPosts] = useState([]);

    useEffect(() => {
        axios.get("/api/post?limit=5").then((res) => {
            console.log(res);
            if (res && res.data) {
                const { data } = res.data;
                setPosts(data);
            }
        });
    }, []);

    const Map = dynamic(() => import("@/components/Map"), {
        ssr: false,
        loading: () => <p>Loading...</p>,
    });

    return <>
        {/* <!-- ======Section======= --> */}
        <div className="section flex flex-sb">
            {/* <!-- Section Left --> */}
            <div className="section-left">
                {/* <!-- ======Banner======= --> */}
                <div>
                    <Map></Map>
                </div>

                <div className="nfts">
                    <div className="trending heading flex flex-sb">
                        <h2>B√†i ƒëƒÉng v·ªÅ ve chai c·∫ßn b√°n</h2>
                    </div>

                    {/* <!-- ======Categories======= --> */}

                    <div className="categories flex flex-sb">
                        <div className="category flex">
                            <div className="icon">üî•</div>
                            <p>Tin n·ªïi b·∫≠t</p>
                        </div>

                        <div className="category flex">
                            <FcNews style={{ marginRight: '10px' }} className='icon' />
                            <p>B·∫£ng tin</p>
                        </div>

                        <div className="category flex">
                            <div className="icon">üïπÔ∏è</div>
                            <p>G·∫ßn b·∫°n</p>
                        </div>

                        <div className="category flex">
                            <FcShop style={{ marginRight: '10px' }} className='icon' />
                            <p>C√°c v·ª±a</p>
                        </div>
                    </div>

                    {/*C√°c b√†i vi·∫øt*/}
                    <PostDashboard posts={posts}></PostDashboard>
                    {/*Sroll */}
                    <scroll></scroll>

                </div>

            </div>

            {/* <!-- Section Right --> */}
            <div className="section-right">

                <div className="top-yards">
                    <div className="heading flex flex-sb">
                        <h2>Top V·ª±a Ve Chai</h2>
                        <p style={{ fontSize: '1rem' }}>Xem th√™m</p>
                    </div>

                </div>
                <div className="top-creators">
                    <div className="heading flex flex-sb">
                        <h2>Top Thu Mua</h2>
                        <p style={{ fontSize: '1rem' }}>Xem th√™m</p>
                    </div>

                    <div className="creator flex flex-sb">
                        <div className="follow-creator flex">
                            <img
                                src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                alt=""
                            />
                            <div className="creator-details">
                                <h3>Huy Nguy·ªÖn</h3>
                                <p>@huynguyen</p>
                            </div>
                        </div>

                        <a href="#" className="btn following">
                            ƒêang theo
                        </a>
                    </div>

                    <div className="creator flex flex-sb">
                        <div className="follow-creator flex">
                            <img
                                src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                alt=""
                            />
                            <div className="creator-details">
                                <h3>Ng√¢n Nguy·ªÖn</h3>
                                <p>@bichngan</p>
                            </div>
                        </div>

                        <a href="#" className="btn follow following">
                            Theo d√µi
                        </a>
                    </div>

                    <div className="creator flex flex-sb">
                        <div className="follow-creator flex">
                            <img
                                src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                alt=""
                            />
                            <div className="creator-details">
                                <h3>Hassnain Haider</h3>
                                <p>@hassnain</p>
                            </div>
                        </div>

                        <a href="#" className="btn follow following">
                            Theo d√µi
                        </a>
                    </div>

                    <div className="creator flex flex-sb">
                        <div className="follow-creator flex">
                            <img
                                src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                alt=""
                            />
                            <div className="creator-details">
                                <h3>Hassnain Haider</h3>
                                <p>@hassnain</p>
                            </div>
                        </div>

                        <a href="#" className="btn follow following">
                            Theo d√µi
                        </a>
                    </div>

                    <div className="creator flex flex-sb">
                        <div className="follow-creator flex">
                            <img
                                src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                alt=""
                            />
                            <div className="creator-details">
                                <h3>Hassnain Haider</h3>
                                <p>@hassnain</p>
                            </div>
                        </div>

                        <a href="#" className="btn follow following">
                            Theo d√µi
                        </a>
                    </div>

                    <div className="creator flex flex-sb">
                        <div className="follow-creator flex">
                            <img
                                src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                alt=""
                            />
                            <div className="creator-details">
                                <h3>Hassnain Haider</h3>
                                <p>@hassnain</p>
                            </div>
                        </div>

                        <a href="#" className="btn follow following">
                            Theo d√µi
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {/* <!-- ======End Section======= --> */}
    </>
}

function SalerComponent({ userData }) {
    const Map = dynamic(() => import("@/components/Map"), {
        ssr: false,
        loading: () => <p>Loading...</p>,
    });

    const [posts, setPosts] = useState([]);
    const [modal, setModal] = useState(false);

    useEffect(() => {
        refreshPosts()
      }, []);
    
      const refreshPosts = () => {
        axios.get("/api/post?limit=5").then((res) => {
          console.log(res);
          if (res && res.data) {
            const { data } = res.data;
            setPosts(data);
          }
        });
      }
    const toggle = () => setModal(!modal);

    const handleCreatedCB = () => {
        setModal(false)
        refreshPosts()
    }

    const handleClosePost =() => {
        setModal(false)
    }

    return (
        <>
            {/* <!-- ======Section======= --> */}
            <div className="section flex flex-sb">
                {/* <!-- Section Left --> */}
                <div className="section-left">
                    {/* <!-- ======Banner======= --> */}
                    <p className='maptitle'>B·∫£n ƒë·ªì ch·ªâ v·ªã tr√≠ c·ªßa c√°c v·ª±a ve chai g·∫ßn b·∫°n</p>
                    <div>
                        <Map></Map>
                    </div>

                    <div className="nfts">
                        <div className="trending heading flex flex-sb">
                            <h2>B√†i ƒëƒÉng v·ªÅ ve chai c·∫ßn b√°n</h2>
                            <p onClick={toggle}>T·∫°o b√†i vi·∫øt</p>
                        </div>

                        {/* <!-- ======Categories======= --> */}

                        <div className="categories flex flex-sb">
                            <div className="category flex">
                                <div className="icon">üî•</div>
                                <p>Tin n·ªïi b·∫≠t</p>
                            </div>

                            <div className="category flex">
                                <FcNews style={{ marginRight: '10px' }} className='icon' />
                                <p>B·∫£ng tin</p>
                            </div>

                            <div className="category flex">
                                <div className="icon">üïπÔ∏è</div>
                                <p>G·∫ßn b·∫°n</p>
                            </div>

                            <div className="category flex">
                                <FcShop style={{ marginRight: '10px' }} className='icon' />
                                <p>C√°c v·ª±a</p>
                            </div>
                        </div>
                        {/* <!-- =====Bai Viet===== --> */}
                        <PostDashboard posts={posts}></PostDashboard>
                    </div>
                </div>

                {/* <!-- Section Right --> */}
                <div className="section-right">

                    <div className="top-yards">
                        <div className="heading flex flex-sb">
                            <h2>Top V·ª±a Ve Chai</h2>
                            <p style={{ fontSize: '1rem' }}>Xem th√™m</p>
                        </div>
                        <div className='yards'>
                            <div className='nameshop'>
                                <BsPinMapFill className='yard-icon'></BsPinMapFill>
                                <h4>V·ª±a Ve Chai</h4>
                            </div>
                            <p>162 ƒê. Hi·ªáp Th√†nh 13, Hi·ªáp Th√†nh, Qu·∫≠n 12, Th√†nh ph·ªë H·ªì Ch√≠ Minh</p>
                        </div>

                    </div>
                    <div className="top-creators">
                        <div className="heading flex flex-sb">
                            <h2>Top Thu Mua</h2>
                            <p style={{ fontSize: '1rem' }}>Xem th√™m</p>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Huy Nguy·ªÖn</h3>
                                    <p>@huynguyen</p>
                                </div>
                            </div>

                            <a href="#" className="btn following">
                                ƒêang theo
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Ng√¢n Nguy·ªÖn</h3>
                                    <p>@bichngan</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {/* <!-- ======End Section======= --> */}

            <Modal isOpen={modal} toggle={toggle}>
                <ModalHeader><span style={{ color: "black", width: '140px', padding: '8px' }}>T·∫°o b√†i vi·∫øt m·ªõi</span></ModalHeader>
                <ModalBody>
                    <CreatePost userData={userData} handleCreatedCB={handleCreatedCB} handleClosePost={handleClosePost}></CreatePost>
                </ModalBody>
            </Modal>
        </>
    );
}

function YardComponent({ userData }) {
    const Map = dynamic(() => import("@/components/Map"), {
        ssr: false,
        loading: () => <p>Loading...</p>,
    });

    const [posts, setPosts] = useState([]);
    const [modal, setModal] = useState(false);

    useEffect(() => {
        refreshPosts()
      }, []);
    
      const refreshPosts = () => {
        axios.get("/api/post?limit=5").then((res) => {
          console.log(res);
          if (res && res.data) {
            const { data } = res.data;
            setPosts(data);
          }
        });
      }
    const toggle = () => setModal(!modal);

    const handleCreatedCB = () => {
        setModal(false)
        refreshPosts()
    }

    const handleClosePost =() => {
        setModal(false)
    }

    return (
        <>
            {/* <!-- ======Section======= --> */}
            <div className="section flex flex-sb">
                {/* <!-- Section Left --> */}
                <div className="section-left">
                    {/* <!-- ======Banner======= --> */}
                    <p className='maptitle'>B·∫£n ƒë·ªì ch·ªâ v·ªã tr√≠ c·ªßa c√°c v·ª±a ve chai g·∫ßn b·∫°n</p>
                    <div>
                        <Map></Map>
                    </div>

                    <div className="nfts">
                        <div className="trending heading flex flex-sb">
                            <h2>B√†i ƒëƒÉng v·ªÅ ve chai c·∫ßn b√°n</h2>
                            <p onClick={toggle}>T·∫°o b√†i vi·∫øt</p>
                        </div>

                        {/* <!-- ======Categories======= --> */}

                        <div className="categories flex flex-sb">
                            <div className="category flex">
                                <div className="icon">üî•</div>
                                <p>Tin n·ªïi b·∫≠t</p>
                            </div>

                            <div className="category flex">
                                <FcNews style={{ marginRight: '10px' }} className='icon' />
                                <p>B·∫£ng tin</p>
                            </div>

                            <div className="category flex">
                                <div className="icon">üïπÔ∏è</div>
                                <p>G·∫ßn b·∫°n</p>
                            </div>

                            <div className="category flex">
                                <FcShop style={{ marginRight: '10px' }} className='icon' />
                                <p>C√°c v·ª±a</p>
                            </div>
                        </div>
                        {/* <!-- =====Bai Viet===== --> */}
                        <PostDashboard posts={posts}></PostDashboard>
                    </div>
                </div>

                {/* <!-- Section Right --> */}
                <div className="section-right">

                    <div className="top-yards">
                        <div className="heading flex flex-sb">
                            <h2>Top V·ª±a Ve Chai</h2>
                            <p style={{ fontSize: '1rem' }}>Xem th√™m</p>
                        </div>
                        <div className='yards'>
                            <div className='nameshop'>
                                <BsPinMapFill className='yard-icon'></BsPinMapFill>
                                <h4>V·ª±a Ve Chai</h4>
                            </div>
                            <p>162 ƒê. Hi·ªáp Th√†nh 13, Hi·ªáp Th√†nh, Qu·∫≠n 12, Th√†nh ph·ªë H·ªì Ch√≠ Minh</p>
                        </div>

                    </div>
                    <div className="top-creators">
                        <div className="heading flex flex-sb">
                            <h2>Top Thu Mua</h2>
                            <p style={{ fontSize: '1rem' }}>Xem th√™m</p>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Huy Nguy·ªÖn</h3>
                                    <p>@huynguyen</p>
                                </div>
                            </div>

                            <a href="#" className="btn following">
                                ƒêang theo
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Ng√¢n Nguy·ªÖn</h3>
                                    <p>@bichngan</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>

                        <div className="creator flex flex-sb">
                            <div className="follow-creator flex">
                                <img
                                    src="https://raw.githubusercontent.com/programmercloud/nft-dashboard/main/img/user.png"
                                    alt=""
                                />
                                <div className="creator-details">
                                    <h3>Hassnain Haider</h3>
                                    <p>@hassnain</p>
                                </div>
                            </div>

                            <a href="#" className="btn follow following">
                                Theo d√µi
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {/* <!-- ======End Section======= --> */}

            <Modal isOpen={modal} toggle={toggle}>
                <ModalHeader><span style={{ color: "black", width: '140px', padding: '8px' }}>T·∫°o b√†i vi·∫øt m·ªõi</span></ModalHeader>
                <ModalBody>
                    <CreatePost userData={userData} handleCreatedCB={handleCreatedCB} handleClosePost={handleClosePost}></CreatePost>
                </ModalBody>
            </Modal>
        </>
    );
}